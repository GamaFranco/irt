#!/usr/bin/env ruby

require 'rubygems'
require 'irt'
require 'fileutils'

banner = "irt #{IRT::VERSION} (c) 2010 Domizio Demichelis"

usage = %(
Description:
    Ruby Interactive Testing - Use irb or rails console for testing.

Usage:
    irt [-n|--new] PATH [options] [rails_env]

    [-n|--new]    creates the new file at PATH if the file does not exist
    PATH          path to a single file or dir (<dir>/**/*.irt files)
    [options]     all the options supported by irb or rails console
    [rails_env]   the optional rails environment to load (must be the last arg)

)

if ARGV.empty? || ARGV.first =~ /^(-h|--help)$/
  puts banner + usage
  exit
end

if ARGV.first =~ /^(-v|--version)$/
  puts IRT::VERSION
  exit
end

if ARGV.first =~ /^(-n|--new)$/
  ARGV.shift
  path = ARGV.shift
  unless File.exists?(path)
    dirname = File.dirname(path)
    FileUtils.mkdir_p(dirname) unless File.directory?(dirname)
    File.open(path, 'w') do |f|
      f.puts 'open_session'
    end
  end
end

path ||= ARGV.shift
files = File.directory?(path) ? Dir.glob(File.join(path, '**/*.irt')): [path]
if files.empty?
  puts "No *.irt file to run in #{path}"
  exit
end

irtrc = File.join ENV['HOME'], '.irtrc'
File.open(irtrc, 'w') do |f|
  f.puts "require 'rubygems'\nrequire 'irt'\nrequire 'irt/init"
end unless File.exists?(irtrc)

command = 'irb'
if File.exists?('./config/environment.rb')
  if File.exists?('./script/rails')
    command =  'rails c'
  elsif File.exists?('./script/console')
    command = 'ruby script/console'
  end
  ARGV << 'development' if command != 'irb' && ARGV.last =~ /^-/
end

puts banner

files.each do |file|
  puts "=== Running file #{file} ==="
  ENV["IRT_FILE"] = file
  ENV["IRT_COMMAND"] = "#{command} #{file} #{ARGV * ' '}".strip
  ENV["IRBRC"] = irtrc
  system ENV["IRT_COMMAND"]
end
